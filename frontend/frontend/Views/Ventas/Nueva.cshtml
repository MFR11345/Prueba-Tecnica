@model frontend.Models.VentaViewModel
@{
    ViewData["Title"] = "Nueva Venta";
}

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

<div class="container mt-4">
    <h2>Nueva Venta</h2>

    @if (TempData["Success"] != null)
    {
        <div class="alert alert-success">@TempData["Success"]</div>
    }

    <form asp-action="Nueva" method="post" id="ventaForm">
        <div class="mb-3">
            <label class="form-label">Cliente *</label>
            <select asp-for="ClienteId" class="form-select" asp-items="@(new SelectList(ViewBag.Clientes, "Id", "Nombre"))">
                <option value="">-- Seleccione Cliente --</option>
            </select>
        </div>

        <div class="mb-3">
            <label class="form-label">Fecha *</label>
            <input asp-for="FechaVenta" type="datetime-local" class="form-control"
                   value="@Model.FechaVenta.ToString("yyyy-MM-ddTHH:mm")" />
        </div>

        <h4>Productos</h4>
        <div class="row g-2 align-items-end mb-3">
            <div class="col-md-6">
                <select id="productoSelect" class="form-select">
                    <option value="">-- Seleccione Producto --</option>
                    @foreach (var p in ViewBag.Productos)
                    {
                        <option value="@p.ProductoId" data-precio="@p.Precio">@p.Nombre (@p.Precio.ToString("C"))</option>
                    }
                </select>
            </div>
            <div class="col-md-3">
                <input id="cantidadInput" type="number" min="1" class="form-control" placeholder="Cantidad" />
            </div>
            <div class="col-md-3">
                <button type="button" id="btnAgregar" class="btn btn-primary w-100">Agregar</button>
            </div>
        </div>

        <table class="table" id="tablaDetalles">
            <thead>
                <tr>
                    <th>Producto</th>
                    <th>Cantidad</th>
                    <th>Precio Unitario</th>
                    <th>Subtotal</th>
                    <th></th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>

        <input type="hidden" asp-for="DetallesJson" id="DetallesJson" />

        <button type="submit" class="btn btn-success">Registrar Venta</button>
    </form>
</div>

<script>
    let detalles = [];

    document.getElementById("btnAgregar").addEventListener("click", function () {
        const select = document.getElementById("productoSelect");
        const id = select.value;
        const nombre = select.options[select.selectedIndex].text;
        const precio = parseFloat(select.options[select.selectedIndex].dataset.precio || 0);
        const cantidad = parseInt(document.getElementById("cantidadInput").value);

        if (!id || cantidad <= 0) { alert("Seleccione producto y cantidad válida"); return; }

        const subtotal = cantidad * precio;
        detalles.push({ productoId: parseInt(id), cantidad: cantidad, precioUnitario: precio });

        const fila = `<tr>
            <td>${nombre}</td>
            <td>${cantidad}</td>
            <td>${precio.toFixed(2)}</td>
            <td>${subtotal.toFixed(2)}</td>
            <td><button type="button" class="btn btn-danger btn-sm btnEliminar">X</button></td>
        </tr>`;

        document.querySelector("#tablaDetalles tbody").insertAdjacentHTML("beforeend", fila);
        document.getElementById("DetallesJson").value = JSON.stringify(detalles);

        select.value = "";
        document.getElementById("cantidadInput").value = "";
    });

    document.querySelector("#tablaDetalles").addEventListener("click", function (e) {
        if (e.target.classList.contains("btnEliminar")) {
            const row = e.target.closest("tr");
            const index = Array.from(row.parentNode.children).indexOf(row);
            detalles.splice(index, 1);
            row.remove();
            document.getElementById("DetallesJson").value = JSON.stringify(detalles);
        }
    });
</script>
